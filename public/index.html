<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberincidents Registry</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        h1 { color: #f38020; }
        .form-container { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { min-height: 100px; resize: vertical; }
        button { background: #f38020; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #d66f1a; }
        .incidents-list { background: white; padding: 20px; border-radius: 8px; }
        .incident-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 4px; }
        .pagination { margin-top: 20px; text-align: center; }
        .pagination button { margin: 0 5px; }
        .char-count { font-size: 12px; color: #666; float: right; }
        .incident-card p {
    white-space: pre-wrap;
    word-wrap: break-word;
}
    </style>
</head>
<body>
    <h1>üîí Cyberincidents Registry</h1>
    
    <div class="form-container">
        <h2>Add incident</h2>
        <form id="incidentForm">
            <div class="form-group">
                <label for="customer">Customer:</label>
                <input type="text" id="customer" maxlength="30" required>
                <span class="char-count" id="klientCount">0/30</span>
            </div>
            <div class="form-group">
                <label for="opis">Incident description:</label>
                <textarea id="description" maxlength="500" required></textarea>
                <span class="char-count" id="opisCount">0/500</span>
            </div>
            <div class="form-group">
                <label for="date">Date of the incident:</label>
                <input type="date" id="date" required>
            </div>
            <div class="form-group">
                <label for="implications">Incident implications:</label>
                <textarea id="implications" required></textarea>
            </div>
            <div class="form-group">
                <label for="solution">How Cloudflare helps mitigate the risk:</label>
                <textarea id="solution" required></textarea>
            </div>
            <button type="submit">Add incident</button>
        </form>
    </div>

    <div class="incidents-list">
        <h2>Incidents list</h2>
        <div id="incidentsList"></div>
        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        const currentPage = 1;
        const pageSize = 50;

        // Liczniki znak√≥w
        document.getElementById('customer').addEventListener('input', (e) => {
            document.getElementById('CustomerCount').textContent = `${e.target.value.length}/30`;
        });
        document.getElementById('opis').addEventListener('input', (e) => {
            document.getElementById('descriptionCount').textContent = `${e.target.value.length}/500`;
        });

        // Dodawanie incydentu
        document.getElementById('incidentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                customer: document.getElementById('klient').value,
                incident_description: document.getElementById('description').value,
                incident_date: document.getElementById('date').value,
                incident_implications: document.getElementById('implications').value,
                cloudflare_solutions: document.getElementById('solutions').value
            };

            try {
                const response = await fetch('/api/incidents', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Incident added!');
                    document.getElementById('incidentForm').reset();
                    document.getElementById('klientCount').textContent = '0/30';
                    document.getElementById('opisCount').textContent = '0/500';
                    loadIncidents(1);
                } else {
                    alert('Error adding incident');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        });

        // ≈Åadowanie listy incydent√≥w
        async function loadIncidents(page) {
            try {
                const response = await fetch(`/api/incidents?page=${page}&limit=50`);
                const result = await response.json();
                
                const container = document.getElementById('incidentsList');
                container.innerHTML = '';
                
                result.incidents.forEach(incident => {
                    const card = document.createElement('div');
                    card.className = 'incident-card';
                    card.innerHTML = `
                        <h3>${incident.customer}</h3>
                        <p><strong>Data:</strong> ${incident.incident_date}</p>
                        <p><strong>Opis:</strong> ${incident.incident_description}</p>
                        <p><strong>Skutki:</strong> ${incident.incident_implications}</p>
                        <p><strong>RozwiƒÖzania Cloudflare:</strong> ${incident.cloudflare_solutions}</p>
                        <button onclick="deleteIncident(${incident.id})">Delete</button>
                    `;
                    container.appendChild(card);
                });

                // Paginacja
                const paginationDiv = document.getElementById('pagination');
                paginationDiv.innerHTML = '';
                
                if (page > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'Previous';
                    prevBtn.onclick = () => loadIncidents(page - 1);
                    paginationDiv.appendChild(prevBtn);
                }
                
                const pageInfo = document.createElement('span');
                pageInfo.textContent = ` Page ${page} (${result.total} incidents) `;
                paginationDiv.appendChild(pageInfo);
                
                if (result.incidents.length === 50) {
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Next';
                    nextBtn.onclick = () => loadIncidents(page + 1);
                    paginationDiv.appendChild(nextBtn);
                }
            } catch (error) {
                alert('Loading error: ' + error.message);
            }
        }

        async function deleteIncident(id) {
            if (!confirm('Are you sure to delete the incident?')) return;
            
            try {
                const response = await fetch(`/api/incidents?id=${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('Incident deleted');
                    loadIncidents(1);
                } else {
                    alert('Deletion error');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ≈Åadowanie przy starcie
        loadIncidents(1);
    </script>
</body>
</html>
